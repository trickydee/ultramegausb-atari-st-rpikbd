================================================================================
BRANCH: bugfixes-rp2350-other-controllers
DATE: October 21, 2025
================================================================================

SUMMARY OF CHANGES:

1. ✅ RP2350 (Pico 2) Support
   - Added PICO_BOARD CMake variable for board selection
   - Default: pico (RP2040)
   - Optional: pico2 (RP2350)
   - Output files automatically named: atari_ikbd_pico.uf2 or atari_ikbd_pico2.uf2
   
   Build commands:
     cmake -B build -S . -DPICO_BOARD=pico    # For Pico 1
     cmake -B build -S . -DPICO_BOARD=pico2   # For Pico 2

2. ✅ Xbox Controller Joystick Counter Fix
   - Problem: Xbox controllers weren't incrementing the joystick count on OLED
   - Fix: Added xinput_joy_count global variable
   - tuh_xinput_mount_cb() now increments counter
   - tuh_xinput_umount_cb() now decrements counter
   - UI shows total: HID joysticks + Xbox controllers

3. ✅ Xbox Controller Splash Screen Reinstated
   - Problem: "XBOX!" splash screen was disabled (#if 0)
   - Fix: Re-enabled splash screen showing:
     * Large "XBOX!" text
     * Controller type (Xbox One, 360 Wired, 360 Wireless, OG)
     * Device address and instance
     * Displays for 2 seconds

4. ✅ Xbox Controller Reconnection Fix
   - Problem: Xbox controller doesn't work after:
     1. Connect Xbox → works
     2. Disconnect Xbox
     3. Connect PS4 controller → works
     4. Disconnect PS4
     5. Reconnect Xbox → DOESN'T WORK ❌
   - Fix: Enhanced register/unregister functions with:
     * Stale pointer detection
     * Proper cleanup
     * Debug logging
     * Defensive programming
   
================================================================================

FILES MODIFIED:

Core Changes:
  • CMakeLists.txt              - RP2350 board selection, output naming
  • src/main.cpp                - Xbox counter, splash screen, UI notifications
  • src/HidInput.cpp            - xinput_joy_count, notification functions
  • src/hid_app_host.c          - UI notification on unmount
  • src/xinput_atari.cpp        - Reconnection fix, enhanced logging

Documentation:
  • BUGFIXES_RP2350.md          - Comprehensive documentation (NEW)
  • CHANGES_SUMMARY.txt         - This file (NEW)

Submodules:
  • pico-sdk                    - Modified content (local patches)

Existing Docs (Modified):
  • Multiple markdown files from previous sessions

================================================================================

TESTING CHECKLIST:

Basic Tests:
  ☐ Keyboard works
  ☐ Mouse works
  ☐ GPIO joysticks work
  ☐ HID USB joysticks work

Xbox Controller Tests:
  ☐ Xbox controller shows "XBOX!" splash when connected
  ☐ Joystick counter shows correct number (Joy:1 when connected)
  ☐ Joystick counter decrements when disconnected
  ☐ D-Pad controls work
  ☐ Left analog stick works
  ☐ A button fires
  ☐ Right trigger fires (>50%)

PS4 Controller Tests:
  ☐ PS4 controller detected
  ☐ Joystick counter increments
  ☐ Controls work

CRITICAL RECONNECTION TEST (THE BUG FIX):
  ☐ 1. Connect Xbox controller → works, shows Joy:1
  ☐ 2. Disconnect Xbox → shows Joy:0
  ☐ 3. Connect PS4 controller → works, shows Joy:1
  ☐ 4. Disconnect PS4 → shows Joy:0
  ☐ 5. **Reconnect Xbox controller → MUST WORK** ✅
  ☐ 6. Test D-Pad, analog stick, buttons → all work
  ☐ 7. Repeat test in different orders

RP2350 Tests (If using Pico 2):
  ☐ Build with -DPICO_BOARD=pico2 succeeds
  ☐ Firmware boots on Pico 2 hardware
  ☐ All USB functionality works
  ☐ No crashes or instability
  ☐ Same features as RP2040 version

================================================================================

BUILD INSTRUCTIONS:

For Raspberry Pi Pico (RP2040):
  rm -rf build
  cmake -B build -S . -DPICO_BOARD=pico -DLANGUAGE=EN
  cd build && make
  # Flash: build/atari_ikbd_pico.uf2

For Raspberry Pi Pico 2 (RP2350):
  rm -rf build
  cmake -B build -S . -DPICO_BOARD=pico2 -DLANGUAGE=EN
  cd build && make
  # Flash: build/atari_ikbd_pico2.uf2

================================================================================

EXPECTED BEHAVIOR CHANGES:

User-Visible Changes:
  1. Xbox controller now shows in joystick counter (was 0, now correct)
  2. "XBOX!" splash screen appears when Xbox controller connected
  3. Xbox controller works reliably after PS4 controller usage
  4. Can build for both Pico and Pico 2 boards

Behind-the-Scenes:
  1. Xbox controllers tracked separately from HID joysticks
  2. Better logging for Xbox controller lifecycle
  3. Proper cleanup on controller disconnect
  4. Board-specific output file names

No Breaking Changes:
  - Fully backward compatible with existing functionality
  - All existing features continue to work
  - No configuration changes required

================================================================================

COMMIT RECOMMENDATION:

Git commands to commit these changes:

  git add CMakeLists.txt
  git add src/main.cpp src/HidInput.cpp src/hid_app_host.c src/xinput_atari.cpp
  git add BUGFIXES_RP2350.md CHANGES_SUMMARY.txt
  git commit -m "Fix Xbox controller bugs and add RP2350 support

  - Fix Xbox controller not incrementing joystick counter
  - Reinstate Xbox splash screen on connection
  - Fix Xbox reconnection issue after PS4 controller usage
  - Add RP2350 (Pico 2) build support with board selection
  
  The Xbox controller counter fix addresses the issue where Xbox
  controllers were detected and working but not shown in the UI
  joystick count.
  
  The reconnection fix resolves the issue where Xbox controllers
  would fail to work after being disconnected and then reconnected,
  especially after using a PS4 controller in between.
  
  RP2350 support allows building firmware for both Pico (RP2040) and
  Pico 2 (RP2350) boards using -DPICO_BOARD= cmake option."

================================================================================

STATUS: ✅ All changes implemented and ready for hardware testing

Next Steps:
  1. Review code changes
  2. Build firmware for your board (pico or pico2)
  3. Flash to hardware
  4. Test with Xbox and PS4 controllers
  5. Verify reconnection behavior
  6. Commit if tests pass

================================================================================

